<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>The MetaRefCard performance conversation</title>
  <meta name="author" content="Valentin Deleplace">
  <link rel="stylesheet" href="static/basiclightbox/basicLightbox.min.css">
  <link rel="stylesheet" href="static/style.css">
</head>

<body>
<div class="conversation">
    <sms-ankur>
        Hey Valentin, I've heard you're into Go and performance
    </sms-ankur>
    <sms-ankur again>
        would you have a look at my HOTAS image processing? Only if you can. Don't spend too much time on this.
    </sms-ankur>
    <sms-valentin>
        Hi Ankur
    </sms-valentin>
    <sms-valentin again>
        What's HOTAS?
    </sms-valentin>
    <sms-ankur>
        It's a flight simulator gaming thing. We generate card images on-the-fly, server-side
    </sms-ankur>
    <sms-ankur again>
        <img src="static/img/metarefcard.jpg" />
    </sms-ankur>
    <sms-valentin>
        Oooh very cool. Sure, I'd be happy to help.
    </sms-valentin>
    <sms-ankur>
        The repo is here
        <a href="https://github.com/ankurkotwal/MetaRefCard">
            github.com/ankurkotwal/MetaRefCard
        </a>
    </sms-ankur>
    <sms-ankur again>
        I'm worried about a memory leak
    </sms-ankur>
    <sms-ankur again>
        Also the image generation is kinda slow, which incurs a midly annoying user-facing latency
    </sms-ankur>
    <sms-valentin>
        Ooh I see you've already written idiomatic tests and benchmarks! That's awesome,
        it will make performance exploration much more straightforward ðŸ“ˆ
    </sms-valentin>
    <sms-ankur>
        I've run tests with 
        <a href="https://blog.golang.org/pprof">Pprof</a>,
        generated some call graphs... still not crystal clear for me
    </sms-ankur>
    <sms-ankur again>
        Before I deploy to Cloud Run, I need to check if the image generation is likely to 
        <a href="https://en.wikipedia.org/wiki/Out_of_memory">OOM</a>
        the regular instance available memory.
        <img src="static/img/cloud_run_memory.png" />
    </sms-ankur>
    <sms-ankur again>
        I could pay more to have several GB, however a memory leak would still crash the instance every few requests ðŸ™„
    </sms-ankur>
    <sms-valentin>
        OK, let's tackle this by 2 sides.
        I'll read the code and try to reproduce the memory leak on my workstation. 
    </sms-valentin>
    <sms-valentin again>
        Meanwhile could you deploy to Cloud Run (low memory), launch a few dozens requests, and see if you actually
        experience any failures?
    </sms-valentin>
    <sms-ankur>
        ðŸ‘Œ
    </sms-ankur>
    <div class=break> </div>
    <sms-valentin>
        So, I ran the tests with the -race flag, turns out there are some data races in the lazy init logic. I opened a <a href="https://github.com/ankurkotwal/MetaRefCard/pull/4/files">PR</a>.
    </sms-valentin>
    <sms-valentin again>
        It's a cultural thing in Go, if a program has data races, we pedantically regard it as broken ðŸ˜‚
        <br/>
        We want to fix the races before improving anything else
    </sms-valentin>
    <sms-valentin again>
        in this case, 
        <a href="https://golang.org/pkg/sync/#Once">sync.Once</a>
        and
        <a href="https://golang.org/pkg/sync/#Map">sync.Map</a>
        come to the rescue
    </sms-valentin>
    <sms-ankur>
        Ah! Thanks, I'll merge it
    </sms-ankur>
    <sms-valentin>
        When requests are processed sequentially, there doesn't seem to be any big memory usage.
        E.g. this is using the 
        <a href="https://making.pusher.com/go-tool-trace/">Trace viewer</a>,
        it never gets above 20MB
        <img src="static/img/trace_seq_small_mem.png" />
    </sms-valentin>
    <sms-ankur>
        Correct. The problem occurs when requests are processed concurrently
    </sms-ankur>
    <sms-ankur>
        which may happen often in production, as each request is taking several seconds to complete
    </sms-ankur>
    <sms-valentin>
        Indeed when I launch a burst of 50 concurrent requests, I can see the memory usage 
        climbing to 750MB
        <img src="static/img/trace_conc_high_mem.png" />
    </sms-valentin>
    <sms-valentin again>
        You know, sometimes the Go runtime allocates large chunks of memory that you actually need and
        doesn't give them back quickly to the OS, and that's mostly OK? This doesn't 
        always mean your code has any memory leak.
    </sms-valentin>
    <sms-valentin again>
        Even if we 
        <a href="https://golang.org/pkg/runtime/#GC">explicitly trigger</a>
        the garbage collection after each request, often the program doesn't 
        seems to release any memory...
    </sms-valentin>
    <sms-valentin again>
        As long as you don't OOM, it's fine if your program is occupying more memory than 
        the amount your code's objects are actually using. It has some leeway. Maybe trust the GC? ðŸ¤·
        <img src="static/img/heap_detail.png" />
    </sms-valentin>
    <sms-ankur>
        I found this very suspicious at first, but okay I'll let the OS and the Go runtime
        haggle over the memory heap, and hope for the best!
    </sms-ankur>
    <sms-ankur again>
        Also I haven't noticed any OOM in Cloud Run so far, this is going good ðŸ¤ž
    </sms-ankur>
    <div class=break> </div>
    <sms-valentin>
        I had a look at the latency problem
    </sms-valentin>
    <sms-valentin again>
        You're drawing multiple text labels on the image in rectangles that don't 
        overlap, so I thought of doing that concurrently
    </sms-valentin>
    <sms-ankur>
        Nah, I thought the same, unfortunately the Font objects are no thread-safe.
        And we don't even need to try harder with more clunky synchronization patterns,
        because the text drawing is actually not the bottleneck!
    </sms-ankur>
    <sms-valentin>
        You're 100% right, we must focus on the actual bottlenecks, and "writing the 
        characters' pixels in the labels" is not one of them.
    </sms-valentin>
    <sms-valentin again>
        So, this is our CPU profile
        <img src="static/img/pprof_overview.png" />
    </sms-valentin>
    <sms-valentin again>
        18% of the total CPU time is spent encoding to JPEG.
    </sms-valentin>
    <sms-valentin again>
        Did you know the drop-in encoder replacement
        <a href="https://github.com/pixiv/go-libjpeg/tree/master/jpeg">
            github.com/pixiv/go-libjpeg/jpeg
        </a>? It can encode 5 times as fast, shaving 15% of the total time. That's a quick win ðŸ˜‰
    </sms-valentin>
    <sms-valentin again>
        Updated CPU profile
        <img src="static/img/pprof_2.png" />
    </sms-valentin>
    <sms-valentin again>
        Now trying to figure out why so much time (15s) is sunk in generateImages, while
        (decode image + draw labels + encode image) is only (3s + 1.1s + 0.6s) = 4.7s...
    </sms-valentin>
    <sms-valentin again>
        Allright, here's what's going on.
        <br/>
        You have a configurable background color, so the process is 
        <ul>
            <li>create a blank RGBA image</li>
            <li>fill it with the custom background color</li>
            <li>draw the card model PNG on top (it has transparency)</li>
            <li>draw the card text labels</li>
        </ul>
    </sms-valentin>
    <sms-valentin again>
        for some reason, drawing the model card converts each pixel between 
        <a href="https://golang.org/pkg/image/color/#NRGBA">NRGBA</a> 
        and 
        <a href="https://golang.org/pkg/image/color/#RGBA">RGBA</a>,
        and that's super slow 
        <img src="static/img/pprof_3.png" />
    </sms-valentin>
    <sms-valentin again>
        okay, mixing "non-alpha-premultiplied" with "alpha-premultiplied" might
        incur some arithmetic extra burden. However, I tried to tweak the code 
        to deal only with RGBA, but no gain! 
        <br/>
        transform_RGBA_RGBA_Over seems just as expensive ðŸ¤·
    </sms-valentin>
    <sms-ankur>
        That's an interesting rabbit hole
    </sms-ankur>
    <sms-ankur again>
        You know what? Choosing the background color is not a core feature of
        my website. I can totally live with a default background color "baked" into the 
        original model card PNG, instead of doing that dynamically each time.
    </sms-ankur>
    <sms-valentin>
        or maybe 3 or 4 variants of the PNG with different pre-baked background colors
    </sms-valentin>
    <div class=break> </div>
    <sms-ankur>
        Hey, I deployed to Cloud Run with your these optimizations:
        baked in background color, alternative JPEG encoder
    </sms-ankur>
    <sms-ankur>
        It's way faster now! ðŸŽ‰
        <br/>
        Thank you for your help!
    </sms-ankur>
    <sms-valentin>
        ðŸ¥³
    </sms-valentin>



    <script src="static/basiclightbox/basicLightbox.min.js"></script>
    <script src="static/script.js"></script>
</div>
</body>
</html>